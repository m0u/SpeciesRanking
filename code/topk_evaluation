import pandas as pd

# Load Excel files
rank_file = pd.ExcelFile("RANK_Canada.xlsx")
pred_file = pd.ExcelFile("predicted_ranks.xlsx")

# Load each sheet with correct index
rank_sheets = {name: rank_file.parse(name).set_index('Group name') for name in rank_file.sheet_names}
pred_sheets = {
    'graph': pred_file.parse('graph').set_index('Species'),
    'regression': pred_file.parse('regression').set_index('Species'),
    'gcn': pred_file.parse('gcn').set_index('Species'),  # Added GCN-based predictions
    'gcn_reg': pred_file.parse('gcn_reg').set_index('Species')
    
}

# Define Top-K Agreement function
def top_k_agreement(true_df, pred_df, k=5):
    true_top_k = set(true_df.sort_values('Rank').head(k).index)
    pred_top_k = set(pred_df.sort_values('Rank').head(k).index)
    overlap = true_top_k & pred_top_k
    return len(overlap) / k, overlap

# Compare predictions with each ground truth sheet
results = []
for gt_name, gt_df in rank_sheets.items():
    for pred_name, pred_df in pred_sheets.items():
        top5_score, top5_overlap = top_k_agreement(gt_df, pred_df, k=5)
        top10_score, top10_overlap = top_k_agreement(gt_df, pred_df, k=10)
        results.append({
            "Ground Truth": gt_name,
            "Prediction": pred_name,
            "Top-5 Agreement": top5_score,
            "Top-5 Overlap": list(top5_overlap),
            "Top-10 Agreement": top10_score,
            "Top-10 Overlap": list(top10_overlap)
        })

# Convert results to DataFrame
results_df = pd.DataFrame(results)
print(results_df)
results_df.to_csv("top_k_similarity_results.csv", index=False)

